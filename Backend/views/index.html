<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>SmartHydrate — Dashboard</title>
        <!-- Include your compiled Tailwind v4 CSS -->
        <!-- Build Tailwind v4 into static/css/tailwind.css with your build pipeline -->
        <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
        <style>
        /* Small helper for truncated event text */
        .truncate-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        </style>
    </head>
    <body class="bg-slate-50 text-slate-800 min-h-screen">
        <div class="max-w-7xl mx-auto p-6">
            <!-- Header -->
            <header class="flex items-center justify-between mb-6">
                <div>
                    <h1 class="text-2xl font-semibold">SmartHydrate</h1>
                    <p class="text-sm text-slate-500">
                        Automatic hydration tracking to help you reach the WHO recommended minimum of 2 L/day
                    </p>
                </div>
                <div class="flex items-center gap-3">
                    <div class="text-right">
                        <div class="text-xs text-slate-500">System status</div>
                        <div class="text-sm font-medium" id="system-status">
                            {% if system_status.online %}
                                <span class="inline-flex items-center gap-2 text-green-600">
                                    <span class="h-2 w-2 rounded-full bg-green-600 inline-block"></span> Online
                                </span>
                            {% else %}
                                <span class="inline-flex items-center gap-2 text-red-600">
                                    <span class="h-2 w-2 rounded-full bg-red-600 inline-block"></span> Offline
                                </span>
                            {% endif %}
                        </div>
                    </div>
                    <button id="add-user-btn"
                            class="inline-flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white text-sm px-4 py-2 rounded-md shadow">
                        + Add New User
                    </button>
                </div>
            </header>
            <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Overall Card -->
                <section class="lg:col-span-1 bg-white rounded-xl shadow p-5">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-lg font-semibold">Overall</h2>
                            <p class="text-sm text-slate-500">All users — today</p>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-slate-500">Goal (WHO)</div>
                            <div class="text-sm font-medium">2.0 L / user</div>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center gap-4">
                        <!-- Circular gauge -->
                        <div class="w-28 h-28 relative">
                            <svg class="w-28 h-28" viewBox="0 0 36 36">
                                <path class="text-slate-200" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="3.2" />
                                <path class="gauge-stroke" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke-width="3.6" stroke-linecap="round" stroke="#4f46e5" stroke-dasharray="100, 100" data-percent="{{ overall.percent | default(0) }}" />
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <div class="text-center">
                                    <div class="text-sm text-slate-500">Avg</div>
                                    <div class="text-lg font-semibold">{{ overall.avg_liters | default(0) }} L</div>
                                    <div class="text-xs text-slate-400">{{ overall.percent | default(0) }}%</div>
                                </div>
                            </div>
                        </div>
                        <div class="flex-1">
                            <div class="text-xs text-slate-500">Total today</div>
                            <div class="text-2xl font-bold">{{ overall.total_liters | default(0) }} L</div>
                            <div class="mt-4">
                                <div class="w-full bg-slate-100 rounded-full h-3 overflow-hidden">
                                    <div class="h-3 rounded-full bg-indigo-600"
                                         style="width: {{ overall.percent | default(0) }}%"></div>
                                </div>
                                <div class="mt-2 text-xs text-slate-500 flex justify-between">
                                    <span>0 L</span>
                                    <span>{{ overall.total_goal_liters | default(0) }} L</span>
                                </div>
                            </div>
                            <div class="mt-4 text-xs text-slate-500">
                                Last sync: <span class="text-slate-700">{{ overall.last_sync | default("—") }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 text-sm text-slate-600">
                        WHO recommended minimum: <strong>2.0 L per adult per day</strong>.
                    </div>
                </section>
                <!-- Users list -->
                <section class="lg:col-span-2">
                    <div class="bg-white rounded-xl shadow p-5">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-semibold">Users</h2>
                            <div class="text-sm text-slate-500">Tap a user for details</div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {% for user in users %}
                                <article class="bg-slate-50 p-4 rounded-lg border border-slate-100 hover:shadow-md transition">
                                    <div class="flex items-start gap-4">
                                        <!-- Circular mini gauge -->
                                        <div class="w-16 h-16 relative flex-shrink-0">
                                            <svg class="w-16 h-16" viewBox="0 0 36 36">
                                                <path class="text-slate-200" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="3.2" />
                                                <path class="user-gauge-stroke" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke-width="3.6" stroke-linecap="round" stroke="#06b6d4" stroke-dasharray="100, 100" data-percent="{{ (user.intake_liters / user.daily_limit_liters * 100) | round(1) if user.daily_limit_liters else 0 }}" />
                                            </svg>
                                            <div class="absolute inset-0 flex items-center justify-center">
                                                <div class="text-center text-xs">
                                                    <div class="font-semibold">{{ user.intake_liters | default(0) }}L</div>
                                                    <div class="text-[10px] text-slate-500">{{ user.daily_limit_ml/1000.00 }}L</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="flex-1">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <div class="flex items-center gap-2">
                                                        <div class="text-sm font-semibold">{{ user.name }}</div>
                                                        <button onclick="deleteUser('{{ user.id }}')" class="text-slate-400 hover:text-red-500 transition-colors" title="Delete User">
                                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                                              <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                                                            </svg>
                                                        </button>
                                                    </div>
                                                    <div class="text-xs text-slate-500">ID: {{ user.id }}</div>
                                                </div>
                                                <div class="text-right">
                                                    {% set pct = (user.intake_liters / user.daily_limit_liters * 100) if user.daily_limit_liters else 0 %}
                                                    <div class="text-sm font-medium">{{ pct | round(0) }}%</div>
                                                    <div class="text-xs text-slate-500">of goal</div>
                                                </div>
                                            </div>
                                            <div class="mt-3">
                                                <div class="w-full bg-slate-100 rounded-full h-2 overflow-hidden">
                                                    <div class="h-2 rounded-full bg-teal-500"
                                                         style="width: {{ pct | round(1) }}%"></div>
                                                </div>
                                            </div>
                                            <div class="mt-3 text-xs text-slate-500 flex items-center justify-between">
                                                <div>
                                                    Last sip: <span class="text-slate-700">{{ user.last_event_time | default("—") }}</span>
                                                </div>
                                                <div class="text-right">
                                                    <div>{{ user.events | length }} events today</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Optionally show last few events -->
                                    {% if user.events %}
                                        <div class="mt-3 text-xs text-slate-600 border-t border-slate-100 pt-3">
                                            <div class="font-medium text-xs text-slate-700 mb-1">Recent events</div>
                                            <ul class="space-y-1">
                                                {% for ev in user.events[:3] %}
                                                    <li class="flex items-center justify-between">
                                                        <span class="truncate-2">{{ ev.time }} — {{ ev.volume_ml }} ml</span>
                                                        <span class="text-slate-500">{{ (ev.volume_ml / 1000) | round(2) }} L</span>
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    {% endif %}
                                </article>
                            {% endfor %}
                        </div>
                    </div>
                    <!-- Extra info area: tips and history quick links -->
                    <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-white rounded-xl shadow p-5">
                            <h3 class="text-sm font-semibold mb-2">Hydration tips</h3>
                            <ul class="text-sm text-slate-600 space-y-2">
                                <li>Carry your bottle — visual cues help form the habit.</li>
                                <li>Set realistic goals — start with 2 L and personalize per activity.</li>
                                <li>Drink before you're thirsty — thirst is a late sign of dehydration.</li>
                            </ul>
                        </div>
                        <div class="bg-white rounded-xl shadow p-5">
                            <h3 class="text-sm font-semibold mb-2">Quick links</h3>
                            <div class="flex flex-col gap-2 text-sm">
                                <a href="/history" class="text-indigo-600 hover:underline">View weekly/monthly trends</a>
                                <a href="/devices" class="text-indigo-600 hover:underline">Manage dispensers</a>
                                <a href="/settings" class="text-indigo-600 hover:underline">User & system settings</a>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </div>
        <!-- Add User Modal (hidden by default) -->
        <div id="add-user-modal"
             class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 p-4">
            <div class="bg-white rounded-lg w-full max-w-md p-6 shadow-lg">
                <div class="flex items-center justify-between mb-4">
                    <h4 class="text-lg font-semibold">Add New User</h4>
                    <button id="close-add-user" class="text-slate-500 hover:text-slate-700">&times;</button>
                </div>
                <form id="add-user-form" class="space-y-4">
                    <!-- Camera Section -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Face Capture (Required)</label>
                        <div class="relative w-full bg-slate-900 rounded-lg overflow-hidden aspect-video ring-1 ring-slate-200">
                            <!-- Video Feed -->
                            <video id="camera-feed" class="w-full h-full object-cover transform scale-x-[-1]" autoplay playsinline muted></video>
                            
                            <!-- Canvas for capture (hidden) -->
                            <canvas id="camera-canvas" class="hidden"></canvas>
                            
                            <!-- Captured Image Preview -->
                            <img id="camera-preview" alt="Captured Face" width="640" height="360" class="hidden w-full h-full object-cover transform scale-x-[-1]" />
                            
                            <!-- Placeholder / Status -->
                            <div id="camera-status" class="absolute inset-0 flex items-center justify-center text-slate-400 text-sm bg-slate-100">
                                Camera required
                            </div>
                        </div>

                        <!-- Camera Controls -->
                        <div class="mt-2 flex justify-center gap-3">
                            <button type="button" id="btn-start-camera" 
                                    class="px-3 py-1.5 text-xs font-medium bg-slate-200 hover:bg-slate-300 rounded text-slate-700 transition-colors">
                                Start Camera
                            </button>
                            <button type="button" id="btn-capture" disabled
                                    class="px-3 py-1.5 text-xs font-medium bg-indigo-600 hover:bg-indigo-700 text-white rounded disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                Take Picture
                            </button>
                            <button type="button" id="btn-retake" class="hidden px-3 py-1.5 text-xs font-medium bg-amber-100 hover:bg-amber-200 text-amber-800 rounded transition-colors">
                                Retake
                            </button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm text-slate-700">Name</label>
                        <input name="name"
                               required
                               class="mt-1 block w-full rounded-md border-slate-200 shadow-sm px-3 py-2" />
                    </div>
                    <div>
                        <label class="block text-sm text-slate-700">Daily limit (L)</label>
                        <input name="daily_limit"
                               type="number"
                               step="0.1"
                               value="2.0"
                               required
                               class="mt-1 block w-full rounded-md border-slate-200 shadow-sm px-3 py-2" />
                    </div>
                    <div>
                        <label class="block text-sm text-slate-700">Pains (comma separated)</label>
                        <input name="pains"
                               placeholder="e.g. headache, fatigue"
                               class="mt-1 block w-full rounded-md border-slate-200 shadow-sm px-3 py-2" />
                    </div>
                    <div class="flex items-center justify-end gap-2 pt-2 border-t border-slate-100">
                        <button type="button"
                                id="cancel-add-user"
                                class="px-3 py-2 rounded-md text-sm bg-slate-100 hover:bg-slate-200 text-slate-600">Cancel</button>
                        <button type="submit" class="px-4 py-2 rounded-md bg-indigo-600 hover:bg-indigo-700 text-white shadow-sm">Add user</button>
                    </div>
                </form>
            </div>
        </div>
        <script>
        // Camera Variables
        let stream = null;
        let capturedImageBase64 = null;
        
        const videoEl = document.getElementById('camera-feed');
        const canvasEl = document.getElementById('camera-canvas');
        const previewEl = document.getElementById('camera-preview');
        const statusEl = document.getElementById('camera-status');
        
        const btnStart = document.getElementById('btn-start-camera');
        const btnCapture = document.getElementById('btn-capture');
        const btnRetake = document.getElementById('btn-retake');

        // Modal handling
        const addBtn = document.getElementById('add-user-btn');
        const modal = document.getElementById('add-user-modal');
        const closeBtn = document.getElementById('close-add-user');
        const cancelBtn = document.getElementById('cancel-add-user');

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            videoEl.srcObject = null;
        }

        function resetCameraUI() {
            stopCamera();
            capturedImageBase64 = null;
            
            videoEl.classList.remove('hidden');
            previewEl.classList.add('hidden');
            statusEl.classList.remove('hidden'); // Show "Camera required" overlay
            statusEl.textContent = 'Camera required';
            statusEl.classList.replace('hidden', 'flex'); // Ensure flex is on if it was hidden

            btnStart.classList.remove('hidden');
            btnCapture.classList.remove('hidden');
            btnCapture.disabled = true;
            btnRetake.classList.add('hidden');
        }

        function getUserMediaCompat(constraints) {
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    return navigator.mediaDevices.getUserMedia(constraints);
                }

                const legacy = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
                if (!legacy) {
                    return Promise.reject(new Error('getUserMedia is not supported in this browser.'));
                }

                return new Promise((resolve, reject) => {
                    legacy.call(navigator, constraints, resolve, reject);
                });
            }


        async function startCamera() {
                try {
                    statusEl.textContent = 'Requesting access...';

                    if (!window.navigator) throw new Error('Navigator not available');

                    // Optional debug logs:
                    console.log('navigator.mediaDevices:', navigator.mediaDevices);
                    console.log('userAgent:', navigator.userAgent);

                    stream = await getUserMediaCompat({ video: true });
                    videoEl.srcObject = stream;

                    statusEl.classList.add('hidden');
                    statusEl.classList.remove('flex');
                    btnStart.classList.add('hidden');
                    btnCapture.disabled = false;
                } catch (err) {
                    console.error('camera error:', err);
                    statusEl.textContent = 'Camera access denied or unavailable';
                    statusEl.classList.remove('hidden');
                    btnCapture.disabled = true;
                }
            }


        btnStart?.addEventListener('click', startCamera);

        btnCapture?.addEventListener('click', () => {
            if (!stream) return;
            
            // Set canvas dim to match video
            canvasEl.width = videoEl.videoWidth;
            canvasEl.height = videoEl.videoHeight;
            
            const ctx = canvasEl.getContext('2d');
            // Check if we need to flip the context if I applied CSS transform scale-x-[-1]
            // Actually, the CSS transform only affects display. The read data is raw.
            // If we want the saved image to look like the mirror view, we must flip it on canvas.
            ctx.translate(canvasEl.width, 0);
            ctx.scale(-1, 1);
            
            ctx.drawImage(videoEl, 0, 0, canvasEl.width, canvasEl.height);
            
            capturedImageBase64 = canvasEl.toDataURL('image/jpeg', 0.8);
            previewEl.src = capturedImageBase64;
            
            // Switch UI
            videoEl.classList.add('hidden');
            previewEl.classList.remove('hidden');
            btnCapture.classList.add('hidden');
            btnRetake.classList.remove('hidden');
            
            // Stop stream to save battery/led
            stopCamera();
        });

        btnRetake?.addEventListener('click', () => {
            resetCameraUI();
            startCamera(); // Restart immediately
        });

        addBtn?.addEventListener('click', () => {
            resetCameraUI();
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            // Auto-start camera for convenience? Let's wait for user button or do it.
            // Let's do auto-start
            startCamera();
        });

        [closeBtn, cancelBtn].forEach(el => el?.addEventListener('click', () => {
            stopCamera();
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }));

        // Form handling
        const addUserForm = document.getElementById('add-user-form');
        addUserForm?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!capturedImageBase64) {
                alert('You must capture a photo before adding the user.');
                return;
            }

            const formData = new FormData(addUserForm);
            
            // Construct JSON payload
            const painsStr = formData.get('pains')?.toString() || '';
            const painsArray = painsStr.split(',').map(p => p.trim()).filter(p => p.length > 0);
            
            const payload = {
                name: formData.get('name'),
                daily_limit: parseFloat(formData.get('daily_limit')),
                pains: painsArray,
                image: capturedImageBase64
            };

            try {
                const res = await fetch('/add-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (res.ok) {
                    window.location.reload(); 
                } else {
                    const err = await res.json();
                    alert('Error adding user: ' + (err.error || 'Unknown error'));
                }
            } catch (error) {
                console.error(error);
                alert('Network error adding user');
            }
        });

        // Gauge rendering: convert data-percent to stroke-dashoffset
        function renderGauges() {
            const circumference = 100; // We're reusing a dasharray of 100 for simplicity
            // Overall gauge
            document.querySelectorAll('.gauge-stroke, .user-gauge-stroke').forEach(path => {
                const pct = parseFloat(path.getAttribute('data-percent')) || 0;
                const clamped = Math.max(0, Math.min(100, pct));
                // stroke-dasharray is already 100, so stroke-dashoffset = 100 - pct
                const offset = circumference - clamped;
                path.setAttribute('stroke-dashoffset', offset);
                // color shift: green if >=100, else teal-indigo gradient
                if (clamped >= 100) {
                    path.setAttribute('stroke', '#16a34a'); // green
                } else if (clamped >= 75) {
                    path.setAttribute('stroke', '#06b6d4'); // teal
                } else {
                    path.setAttribute('stroke', '#4f46e5'); // indigo
                }
            });
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            renderGauges();
        });

        // Delete user
        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user?')) return;
            
            try {
                const res = await fetch('/delete-users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId })
                });
                
                if (res.ok) {
                    window.location.reload(); 
                } else {
                    const err = await res.json();
                    alert('Error deleting user: ' + (err.error || 'Unknown error'));
                }
            } catch (error) {
                console.error(error);
                alert('Network error deleting user');
            }
        }
        </script>
    </body>
</html>
